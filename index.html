<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Verified Telemetry: Verified Telemetry API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Verified Telemetry
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Verified Telemetry API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Overview</h1>
<p>This is the companion API documentation for the Verified Telemetry <a href="https://github.com/Azure/Verified-Telemetry">GitHub Repository</a>.</p>
<p>The following API documentation outlines the structure for both the Azure RTOS and the FreeRTOS Verified Telemetry SDK:</p>
<ul>
<li><a href="nx__verified__telemetry_8h.html">Verified Telemetry Azure RTOS SDK</a></li>
<li><a href="_free_r_t_o_s__verified__telemetry_8h.html">Verified Telemetry FreeRTOS SDK</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Library Structure</h1>
<p>The Verified Telemetry library has been structured around the following components:</p>
<p><b><a href="./src/core">core</a></b> <br  />
 Core functions to support verified telemetry, such as functions to collect, validate and evaluate sensor fingerprints.</p>
<p><b><a href="./src/middleware">middleware</a></b> <br  />
 The implementations to support interactions with Azure IoT Middleware for Azure RTOS and FreeRTOS.</p>
<p><b><a href="./src/platform">platform</a></b> <br  />
 The hardware compatibility layer.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
File Structure</h1>
<p>The file structure is as follows:</p>
<p><b>inc/</b> <br  />
 Contains header files for core, middleware and platform components.</p>
<p><b>src/</b> <br  />
 Contains the library implementations.</p>
<p><b>PnPModel/</b> <br  />
 Contains sample Plug and Play device models to support Verified Telemetry.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Azure RTOS integration guide</h1>
<p>Developers can refer to the <a href="https://github.com/Azure/Verified-Telemetry-Device-Sample">Azure RTOS Device Samples</a> for Verified Telemetry sample code.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Step 1 - Include Verified Telemetry library</h2>
<ol type="1">
<li>In the root folder, run the following command <pre class="fragment"> git submodule add https://github.com/Azure/Verified-Telemetry.git core/lib/verified-telemetry
</pre></li>
</ol>
<ol type="1">
<li>Include library files in <a href="https://github.com/azure-rtos/getting-started/blob/master/MXChip/AZ3166/lib/CMakeLists.txt">getting-started/MXChip/AZ3166/lib/CMakeLists.txt</a> <pre class="fragment"> add_subdirectory(${CORE_LIB_DIR}/verified-telemetry verified_telemetry)
</pre></li>
</ol>
<h2><a class="anchor" id="autotoc_md6"></a>
Step 2 - Initialize Verified Telemetry</h2>
<ol type="1">
<li>Global Verified Telemetry needs to be initialized with the device specific platform functions</li>
</ol>
<ol type="1">
<li>Similarly, to initalize Verified Telemetry for a particular sensor/telemetry the details of sensor connection must be passed using the nx_vt_signature_init function</li>
</ol>
<ol type="1">
<li>An example of usage of <a href="https://azure.github.io/Verified-Telemetry/nx__verified__telemetry_8h.html">nx_vt_init</a> and <a href="https://azure.github.io/Verified-Telemetry/nx__verified__telemetry_8h.html#af097ec10f7efe9e8ef6505166938b46c">nx_vt_signature_init</a> functions is shown below</li>
</ol>
<ol type="1">
<li>Include headers for VT <pre class="fragment"> #include "nx_verified_telemetry.h"
</pre></li>
</ol>
<ol type="1">
<li>Include header which define platform specific device drivers <pre class="fragment"> #include "sample_vt_device_driver.h"
</pre></li>
</ol>
<ol type="1">
<li>Define Verified Telemetry DB which will store configuration, platform specific device drivers and runtime information <pre class="fragment"> static NX_VERIFIED_TELEMETRY_DB verified_telemetry_DB;
</pre></li>
</ol>
<ol type="1">
<li>Define variable of VT_DEVICE_DRIVER type which will contain pointers to platform specific functions required by VT <pre class="fragment"> static VT_DEVICE_DRIVER sample_device_driver;
</pre></li>
</ol>
<ol type="1">
<li>Define scratch buffer of length VT_RECOMMENDED_BUFFER_SIZE_BYTES (2500 bytes). Thus buffer would be used by the library to store runtime signatures <pre class="fragment"> static char scratch_buffer[VT_RECOMMENDED_BUFFER_SIZE_BYTES];
</pre></li>
</ol>
<ol type="1">
<li>Define a variables of NX_VT_OBJECT type for each telemetry that will be supporting Verified Telemetry <pre class="fragment"> static NX_VT_OBJECT sample_signature_sensor_1;
 // static NX_VT_OBJECT sample_signature_sensor_2;
 static NX_VT_OBJECT sample_signature_sensor_N;
</pre></li>
</ol>
<ol type="1">
<li>Define variables of VT_SENSOR_HANDLE type which will contain connection information for each sensor <pre class="fragment"> static VT_SENSOR_HANDLE sample_handle_sensor_1;
 // static VT_SENSOR_HANDLE sample_handle_sensor_2;
 static VT_SENSOR_HANDLE sample_handle_sensor_N;
</pre></li>
</ol>
<ol type="1">
<li>Define a Verified Telemetry User Initialization wrapper function which will make calls to necessary initialization function from the vT library and return pointer to the configured NX_VERIFIED_TELEMETRY_DB variable <pre class="fragment"> NX_VERIFIED_TELEMETRY_DB* sample_nx_verified_telemetry_user_init()
 {
     UINT status;

     sample_device_driver.adc_init          = &amp;vt_adc_init;
     sample_device_driver.adc_read          = &amp;vt_adc_read;
     sample_device_driver.gpio_on           = &amp;vt_gpio_on;
     sample_device_driver.gpio_off          = &amp;vt_gpio_off;
     sample_device_driver.tick_init         = &amp;vt_tick_init;
     sample_device_driver.tick_deinit       = &amp;vt_tick_deinit;
     sample_device_driver.tick              = &amp;vt_tick;
     sample_device_driver.interrupt_enable  = &amp;vt_interrupt_enable;
     sample_device_driver.interrupt_disable = &amp;vt_interrupt_disable;

     if ((status = nx_vt_init(&amp;verified_telemetry_DB, (UCHAR*)"vTDevice", true, &amp;sample_device_driver, scratch_buffer)))
     {
         printf("Failed to configure Verified Telemetry settings: error code = 0x%08x\r\n", status);
     }

     sample_handle_sensor_1.adc_id         = vt_adc_id_sensor_1;
     sample_handle_sensor_1.adc_controller = (void*)&amp;vt_adc_controller_sensor_1;
     sample_handle_sensor_1.adc_channel    = (void*)&amp;vt_adc_channel_sensor_1;
     sample_handle_sensor_1.gpio_id        = vt_gpio_id_sensor_1;
     sample_handle_sensor_1.gpio_port      = (void*)vt_gpio_port_sensor_1;
     sample_handle_sensor_1.gpio_pin       = (void*)&amp;vt_gpio_pin_sensor_1;

     if ((status = nx_vt_signature_init(&amp;verified_telemetry_DB,
         &amp;sample_signature_sensor_1,
         (UCHAR*)"soilMoistureExternal1",
         VT_SIGNATURE_TYPE_FALLCURVE,
         (UCHAR*)"soilMoistureExternal1",
         true,
         &amp;sample_handle_sensor_1)))
     {
         printf("Failed to initialize VT for soilMoistureExternal1 telemetry: error code = 0x%08x\r\n", status);
     }

     return (&amp;verified_telemetry_DB);
 }
</pre></li>
</ol>
<ol type="1">
<li>Call the Verified Telemetry User Initialization wrapper function and update verified_telemetry_DB <pre class="fragment"> verified_telemetry_DB = sample_pnp_verified_telemetry_user_init();
</pre></li>
</ol>
<ol type="1">
<li>A complete sample can be found <a href="https://github.com/Azure/Verified-Telemetry-Device-Sample/blob/main/MXChip/AZ3166/app/sample_nx_verified_telemetry_init.c">here</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md7"></a>
Step 3 - Use VT Middleware APIs based on the following guidelines</h2>
<ol type="1">
<li>Use this function to initialize VT PnP Components <pre class="fragment"> nx_vt_azure_iot_pnp_client_component_add(verified_telemetry_DB, iotpnp_client_ptr)
</pre></li>
</ol>
<ol type="1">
<li>Call these functions once after boot <pre class="fragment"> nx_vt_send_desired_property_after_boot(verified_telemetry_DB, pnp_client_ptr, message_type)

 nx_vt_process_reported_property_sync(
     verified_telemetry_DB, pnp_client_ptr, component_ptr, component_len, &amp;name_value_reader, version)
</pre></li>
</ol>
<ol type="1">
<li>Call these functions at fixed time intervals <pre class="fragment"> nx_vt_properties(verified_telemetry_DB, &amp;(context-&gt;iotpnp_client))

 nx_vt_compute_evaluate_fingerprint_all_sensors(verified_telemetry_DB)
</pre></li>
</ol>
<ol type="1">
<li>Use this function to send telemetry <pre class="fragment"> nx_vt_verified_telemetry_message_create_send(handle-&gt;verified_telemetry_DB,
     iotpnp_client_ptr,
     handle-&gt;component_name_ptr,
     handle-&gt;component_name_length,
     NX_WAIT_FOREVER,
     (UCHAR*)scratch_buffer,
     buffer_length)
</pre></li>
</ol>
<ol type="1">
<li>Desired Property Callback <pre class="fragment"> nx_vt_process_property_update(
     verified_telemetry_DB, pnp_client_ptr, component_ptr, component_len, &amp;name_value_reader, version)
</pre></li>
</ol>
<ol type="1">
<li>Command Callback <pre class="fragment"> nx_vt_process_command(verified_telemetry_DB,
     &amp;(sample_context_ptr-&gt;iotpnp_client),
     UCHAR*)component_name_ptr,
     component_name_length,
     (UCHAR*)pnp_command_name_ptr,
     pnp_command_name_length,
     &amp;json_reader,
     &amp;json_writer,
     &amp;status_code))
</pre> </li>
</ol>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
